<div class="task-form-container">
  <div class="form-header">
    <h1>
      <ng-icon [name]="isEditMode ? 'heroPencilSquare' : 'heroDocumentPlus'" size="28"></ng-icon>
      {{ isEditMode ? 'Editar Tarefa' : 'Nova Tarefa' }}
    </h1>
    <button type="button" class="btn-back" (click)="goBack()">
      <ng-icon name="heroArrowLeft" size="18"></ng-icon>
      Voltar
    </button>
  </div>

  <div class="error-alert" *ngIf="errorMessage">
    <ng-icon name="heroExclamationCircle" size="20"></ng-icon>
    {{ errorMessage }}
  </div>

  <form [formGroup]="taskForm" (ngSubmit)="onSubmit()" class="task-form">
    <div class="form-group">
      <label for="title">
        <ng-icon name="heroCheckCircle" size="18"></ng-icon>
        Título *
      </label>
      <input
        type="text"
        id="title"
        formControlName="title"
        placeholder="Digite o título da tarefa"
        [class.error]="title?.invalid && title?.touched"
      />
      <span class="error-message" *ngIf="title?.invalid && title?.touched">
        <ng-icon name="heroExclamationCircle" size="16"></ng-icon>
        <span *ngIf="title?.errors?.['required']">Título é obrigatório</span>
        <span *ngIf="title?.errors?.['minlength']">Título deve ter no mínimo 3 caracteres</span>
      </span>
    </div>

    <div class="form-group">
      <label for="description">
        <ng-icon name="heroDocumentText" size="18"></ng-icon>
        Descrição
      </label>
      <textarea
        id="description"
        formControlName="description"
        rows="4"
        placeholder="Descreva a tarefa..."
      ></textarea>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="status">
          <ng-icon name="heroCheckCircle" size="18"></ng-icon>
          Status *
        </label>
        <select
          id="status"
          formControlName="status"
          [class.error]="status?.invalid && status?.touched"
        >
          <option value="" disabled>Selecione o status</option>
          <option *ngFor="let s of statuses" [value]="s.value">
            {{ s.label }}
          </option>
        </select>
        <span class="error-message" *ngIf="status?.invalid && status?.touched">
          <ng-icon name="heroExclamationCircle" size="16"></ng-icon>
          Status é obrigatório
        </span>
      </div>

      <div class="form-group">
        <label for="priority">
          <ng-icon name="heroExclamationCircle" size="18"></ng-icon>
          Prioridade *
        </label>
        <select
          id="priority"
          formControlName="priority"
          [class.error]="priority?.invalid && priority?.touched"
        >
          <option value="" disabled>Selecione a prioridade</option>
          <option *ngFor="let p of priorities" [value]="p.value">
            {{ p.label }}
          </option>
        </select>
        <span class="error-message" *ngIf="priority?.invalid && priority?.touched">
          <ng-icon name="heroExclamationCircle" size="16"></ng-icon>
          Prioridade é obrigatória
        </span>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="projectName">
          <ng-icon name="heroFolderOpen" size="18"></ng-icon>
          Projeto *
        </label>
        <select
          id="projectName"
          formControlName="projectName"
          [class.error]="projectName?.invalid && projectName?.touched"
        >
          <option value="" disabled>Selecione um projeto</option>
          <option *ngFor="let project of projects" [value]="project.name">
            {{ project.name }}
          </option>
        </select>
        <span class="error-message" *ngIf="projectName?.invalid && projectName?.touched">
          <ng-icon name="heroExclamationCircle" size="16"></ng-icon>
          Projeto é obrigatório
        </span>
      </div>

      <div class="form-group">
        <label for="dueDate">
          <ng-icon name="heroCalendar" size="18"></ng-icon>
          Data de Vencimento *
        </label>
        <input
          type="date"
          id="dueDate"
          formControlName="dueDate"
          [class.error]="dueDate?.invalid && dueDate?.touched"
        />
        <span class="error-message" *ngIf="dueDate?.invalid && dueDate?.touched">
          <ng-icon name="heroExclamationCircle" size="16"></ng-icon>
          Data de vencimento é obrigatória
        </span>
      </div>
    </div>

    <div class="toggle-container" *ngIf="isEditMode">
      <label class="toggle-label">
        <span>Deseja alterar o Responsável?</span>
        <div class="toggle-switch" (click)="toggleAssigneeEmailField(); $event.preventDefault()">
          <input type="checkbox" [checked]="showAssigneeEmailField" readonly />
          <span class="slider"></span>
        </div>
      </label>
      <small class="current-value" *ngIf="currentTask && !showAssigneeEmailField">
        Responsável atual: {{ currentTask.assignee.email }}
      </small>
    </div>

    <div class="form-group autocomplete-wrapper" *ngIf="!isEditMode || showAssigneeEmailField">
      <label for="assigneeEmail">
        <ng-icon name="heroEnvelope" size="18"></ng-icon>
        Email do Responsável {{ !isEditMode ? '*' : '' }}
      </label>
      <input
        type="email"
        id="assigneeEmail"
        formControlName="assigneeEmail"
        [placeholder]="isEditMode && currentTask ? currentTask.assignee.email : 'Digite o email do responsável'"
        [class.error]="assigneeEmail?.invalid && assigneeEmail?.touched"
        (blur)="onEmailInputBlur()"
        autocomplete="off"
      />
      <div class="suggestions" *ngIf="showSuggestions && emailSuggestions.length > 0">
        <div
          class="suggestion-item"
          *ngFor="let email of emailSuggestions"
          (mousedown)="selectEmail(email)"
        >
          <ng-icon name="heroEnvelope" size="16"></ng-icon>
          {{ email }}
        </div>
      </div>
      <span class="error-message" *ngIf="assigneeEmail?.invalid && assigneeEmail?.touched">
        <ng-icon name="heroExclamationCircle" size="16"></ng-icon>
        <span *ngIf="assigneeEmail?.errors?.['required']">Email é obrigatório</span>
        <span *ngIf="assigneeEmail?.errors?.['email']">Email inválido</span>
      </span>
    </div>

    <div class="form-actions">
      <button type="button" class="btn-cancel" routerLink="/tasks" [disabled]="isLoading">
        <ng-icon name="heroXMark" size="18"></ng-icon>
        Cancelar
      </button>
      <button type="submit" class="btn-submit" [disabled]="isLoading">
        <ng-icon [name]="isLoading ? 'heroArrowPath' : 'heroCheckCircle'" size="18" [class.spin]="isLoading"></ng-icon>
        {{ isLoading ? 'Salvando...' : (isEditMode ? 'Atualizar' : 'Criar Tarefa') }}
      </button>
    </div>
  </form>
</div>
