<div class="form-container">
  <div class="header">
    <h1>
      <ng-icon [name]="isEditMode ? 'heroPencilSquare' : 'heroFolderPlus'" size="28"></ng-icon>
      {{ isEditMode ? 'Editar Projeto' : 'Novo Projeto' }}
    </h1>
    <button type="button" class="btn-back" (click)="goBack()">
      <ng-icon name="heroArrowLeft" size="18"></ng-icon>
      Voltar
    </button>
  </div>

  <div class="form-card">
    <div class="loading" *ngIf="isLoading && isEditMode">
      <ng-icon name="heroArrowPath" size="32" class="spin"></ng-icon>
      <p>Carregando dados do projeto...</p>
    </div>

    <form [formGroup]="projectForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading || !isEditMode">
      <div class="form-group">
        <label for="name">
          <ng-icon name="heroFolderPlus" size="18"></ng-icon>
          Nome do Projeto {{ !isEditMode ? '*' : '' }}
        </label>
        <input
          type="text"
          id="name"
          formControlName="name"
          [placeholder]="isEditMode && currentProject ? currentProject.name : 'Digite o nome do projeto'"
          [class.error]="name?.invalid && name?.touched"
        />
        <span class="error-message" *ngIf="name?.invalid && name?.touched">
          <ng-icon name="heroExclamationCircle" size="16"></ng-icon>
          <span *ngIf="name?.errors?.['required']">Nome é obrigatório</span>
          <span *ngIf="name?.errors?.['minlength']">Nome deve ter no mínimo 3 caracteres</span>
        </span>
      </div>

      <div class="form-group">
        <label for="description">
          <ng-icon name="heroDocumentText" size="18"></ng-icon>
          Descrição
        </label>
        <textarea
          id="description"
          formControlName="description"
          [placeholder]="isEditMode && currentProject ? currentProject.description : 'Descreva o projeto (opcional)'"
          rows="4"
        ></textarea>
      </div>

      <div class="toggle-container" *ngIf="isEditMode">
        <label class="toggle-label">
          <span>Adicionar email do proprietário</span>
          <div class="toggle-switch" (click)="toggleOwnerEmailField(); $event.preventDefault()">
            <input type="checkbox" [checked]="showOwnerEmailField" readonly />
            <span class="slider"></span>
          </div>
        </label>
      </div>

      <div class="form-group" *ngIf="showOwnerEmailField || !isEditMode">
        <label for="ownerEmail">
          <ng-icon name="heroEnvelope" size="18"></ng-icon>
          Email do Proprietário {{ !isEditMode ? '*' : '' }}
        </label>
        <div class="autocomplete-wrapper">
          <input
            type="email"
            id="ownerEmail"
            formControlName="ownerEmail"
            placeholder="Digite o email do proprietário do projeto"
            (blur)="onEmailInputBlur()"
            autocomplete="off"
            [class.error]="projectForm.get('ownerEmail')?.invalid && projectForm.get('ownerEmail')?.touched"
          />
          <div class="suggestions-list" *ngIf="showSuggestions && emailSuggestions.length > 0">
            <div 
              class="suggestion-item" 
              *ngFor="let email of emailSuggestions"
              (click)="selectEmail(email)"
            >
              <div class="user-info">
                <ng-icon name="heroEnvelope" size="16"></ng-icon>
                <span class="user-email">{{ email }}</span>
              </div>
            </div>
          </div>
        </div>
        <span class="error-message" *ngIf="projectForm.get('ownerEmail')?.invalid && projectForm.get('ownerEmail')?.touched">
          <ng-icon name="heroExclamationCircle" size="16"></ng-icon>
          <span *ngIf="projectForm.get('ownerEmail')?.errors?.['required']">Email do proprietário é obrigatório</span>
          <span *ngIf="projectForm.get('ownerEmail')?.errors?.['email']">Email inválido</span>
        </span>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="startDate">
            <ng-icon name="heroCalendar" size="18"></ng-icon>
            Data de Início {{ !isEditMode ? '*' : '' }}
          </label>
          <input
            type="date"
            id="startDate"
            formControlName="startDate"
            [class.error]="startDate?.invalid && startDate?.touched"
          />
          <span class="error-message" *ngIf="startDate?.invalid && startDate?.touched">
            <ng-icon name="heroExclamationCircle" size="16"></ng-icon>
            <span *ngIf="startDate?.errors?.['required']">Data de início é obrigatória</span>
          </span>
          <small class="current-value" *ngIf="isEditMode && currentProject">
            Valor atual: {{ currentProject.startDate | date: 'dd/MM/yyyy' }}
          </small>
        </div>

        <div class="form-group">
          <label for="endDate">
            <ng-icon name="heroCalendar" size="18"></ng-icon>
            Data de Término {{ !isEditMode ? '*' : '' }}
          </label>
          <input
            type="date"
            id="endDate"
            formControlName="endDate"
            [class.error]="endDate?.invalid && endDate?.touched"
          />
          <span class="error-message" *ngIf="endDate?.invalid && endDate?.touched">
            <ng-icon name="heroExclamationCircle" size="16"></ng-icon>
            <span *ngIf="endDate?.errors?.['required']">Data de término é obrigatória</span>
          </span>
          <small class="current-value" *ngIf="isEditMode && currentProject">
            Valor atual: {{ currentProject.endDate | date: 'dd/MM/yyyy' }}
          </small>
        </div>
      </div>

      <div class="error-alert" *ngIf="errorMessage">
        <ng-icon name="heroExclamationCircle" size="20"></ng-icon>
        {{ errorMessage }}
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" routerLink="/projects">
          <ng-icon name="heroXMark" size="18"></ng-icon>
          Cancelar
        </button>
        <button type="submit" class="btn-primary" [disabled]="projectForm.invalid || isLoading">
          <ng-icon [name]="isLoading ? 'heroArrowPath' : 'heroCheckCircle'" size="18" [class.spin]="isLoading"></ng-icon>
          <span *ngIf="!isLoading">{{ isEditMode ? 'Atualizar' : 'Criar' }} Projeto</span>
          <span *ngIf="isLoading">{{ isEditMode ? 'Atualizando' : 'Criando' }}...</span>
        </button>
      </div>
    </form>
  </div>
</div>
