<div class="form-container">
  <div class="header">
    <h1>{{ isEditMode ? 'Editar Projeto' : 'Novo Projeto' }}</h1>
    <button class="btn-back" routerLink="/projects">← Voltar</button>
  </div>

  <div class="form-card">
    <div class="loading" *ngIf="isLoading && isEditMode">
      <p>Carregando dados do projeto...</p>
    </div>

    <form [formGroup]="projectForm" (ngSubmit)="onSubmit()" *ngIf="!isLoading || !isEditMode">
      <div class="form-group">
        <label for="name">Nome do Projeto {{ !isEditMode ? '*' : '' }}</label>
        <input
          type="text"
          id="name"
          formControlName="name"
          [placeholder]="isEditMode && currentProject ? currentProject.name : 'Digite o nome do projeto'"
          [class.error]="name?.invalid && name?.touched"
        />
        <span class="error-message" *ngIf="name?.invalid && name?.touched">
          <span *ngIf="name?.errors?.['required']">Nome é obrigatório</span>
          <span *ngIf="name?.errors?.['minlength']">Nome deve ter no mínimo 3 caracteres</span>
        </span>
      </div>

      <div class="form-group">
        <label for="description">Descrição</label>
        <textarea
          id="description"
          formControlName="description"
          [placeholder]="isEditMode && currentProject ? currentProject.description : 'Descreva o projeto (opcional)'"
          rows="4"
        ></textarea>
      </div>

      <div class="toggle-container" *ngIf="isEditMode">
        <label class="toggle-label">
          <span>Adicionar email do proprietário</span>
          <div class="toggle-switch" (click)="toggleOwnerEmailField(); $event.preventDefault()">
            <input type="checkbox" [checked]="showOwnerEmailField" readonly />
            <span class="slider"></span>
          </div>
        </label>
      </div>

      <div class="form-group" *ngIf="showOwnerEmailField || !isEditMode">
        <label for="ownerEmail">Email do Proprietário {{ !isEditMode ? '*' : '' }}</label>
        <div class="autocomplete-wrapper">
          <input
            type="email"
            id="ownerEmail"
            formControlName="ownerEmail"
            placeholder="Digite o email do proprietário do projeto"
            (blur)="onEmailInputBlur()"
            autocomplete="off"
            [class.error]="projectForm.get('ownerEmail')?.invalid && projectForm.get('ownerEmail')?.touched"
          />
          <div class="suggestions-list" *ngIf="showSuggestions && emailSuggestions.length > 0">
            <div 
              class="suggestion-item" 
              *ngFor="let email of emailSuggestions"
              (click)="selectEmail(email)"
            >
              <div class="user-info">
                <span class="user-email">{{ email }}</span>
              </div>
            </div>
          </div>
        </div>
        <span class="error-message" *ngIf="projectForm.get('ownerEmail')?.invalid && projectForm.get('ownerEmail')?.touched">
          <span *ngIf="projectForm.get('ownerEmail')?.errors?.['required']">Email do proprietário é obrigatório</span>
          <span *ngIf="projectForm.get('ownerEmail')?.errors?.['email']">Email inválido</span>
        </span>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="startDate">Data de Início {{ !isEditMode ? '*' : '' }}</label>
          <input
            type="date"
            id="startDate"
            formControlName="startDate"
            [class.error]="startDate?.invalid && startDate?.touched"
          />
          <span class="error-message" *ngIf="startDate?.invalid && startDate?.touched">
            <span *ngIf="startDate?.errors?.['required']">Data de início é obrigatória</span>
          </span>
          <small class="current-value" *ngIf="isEditMode && currentProject">
            Valor atual: {{ currentProject.startDate | date: 'dd/MM/yyyy' }}
          </small>
        </div>

        <div class="form-group">
          <label for="endDate">Data de Término {{ !isEditMode ? '*' : '' }}</label>
          <input
            type="date"
            id="endDate"
            formControlName="endDate"
            [class.error]="endDate?.invalid && endDate?.touched"
          />
          <span class="error-message" *ngIf="endDate?.invalid && endDate?.touched">
            <span *ngIf="endDate?.errors?.['required']">Data de término é obrigatória</span>
          </span>
          <small class="current-value" *ngIf="isEditMode && currentProject">
            Valor atual: {{ currentProject.endDate | date: 'dd/MM/yyyy' }}
          </small>
        </div>
      </div>

      <div class="error-alert" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" routerLink="/projects">
          Cancelar
        </button>
        <button type="submit" class="btn-primary" [disabled]="projectForm.invalid || isLoading">
          <span *ngIf="!isLoading">{{ isEditMode ? 'Atualizar' : 'Criar' }} Projeto</span>
          <span *ngIf="isLoading">{{ isEditMode ? 'Atualizando' : 'Criando' }}...</span>
        </button>
      </div>
    </form>
  </div>
</div>
