<div class="kanban-container">
  <app-service-unavailable 
    *ngIf="serviceUnavailable && !isLoading"
    [message]="errorMessage"
    (retry)="retryLoad()"
  ></app-service-unavailable>

  <div class="loading" *ngIf="isLoading">
    <ng-icon name="heroArrowPath" size="32" class="spin"></ng-icon>
    <p>Carregando quadro Kanban...</p>
  </div>

  <div class="kanban-content" *ngIf="!isLoading && !serviceUnavailable">
    <div class="kanban-header">
      <div class="header-left">
        <button class="btn-back" [routerLink]="['/projects', project?.id]">
          <ng-icon name="heroArrowLeft" size="18"></ng-icon>
          Voltar
        </button>
        <div class="project-info" *ngIf="project">
          <h1>{{ project.name }}</h1>
          <p>Quadro Kanban</p>
        </div>
      </div>
      <button class="btn-new-task" [routerLink]="['/tasks/new']" [queryParams]="{projectId: project?.id, returnUrl: '/projects/' + project?.id + '/kanban'}">
        <ng-icon name="heroPlus" size="18"></ng-icon>
        Nova Tarefa
      </button>
    </div>

    <div class="error-alert" *ngIf="errorMessage && !serviceUnavailable">
      <ng-icon name="heroExclamationCircle" size="20"></ng-icon>
      {{ errorMessage }}
    </div>

    <div class="kanban-board">
      <div 
        class="kanban-column todo-column"
        [class.drag-over]="draggedOverColumn === 'TODO'"
        (dragover)="onDragOver($event)"
        (dragenter)="onDragEnter('TODO', $event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop('TODO', $event)">
        <div class="column-header">
          <h2>
            <ng-icon name="heroClipboardDocumentList" size="24"></ng-icon>
            A Fazer
          </h2>
          <span class="task-count">{{ todoTasks.length }}</span>
        </div>
        <div class="column-content">
          <div 
            class="kanban-card" 
            *ngFor="let task of todoTasks" 
            draggable="true"
            (dragstart)="onDragStart(task, $event)"
            (dragend)="onDragEnd($event)"
            (click)="navigateToTask(task.id)">
            <div class="card-header">
              <h3>{{ task.title }}</h3>
              <span class="priority-badge" [ngClass]="getPriorityClass(task.priority)">
                {{ getPriorityLabel(task.priority) }}
              </span>
            </div>
            <p class="card-description">{{ task.description }}</p>
            <div class="card-footer">
              <div class="card-info">
                <ng-icon name="heroUser" size="16"></ng-icon>
                <span>{{ task.assignee.name }}</span>
              </div>
              <div class="card-info">
                <ng-icon name="heroCalendar" size="16"></ng-icon>
                <span>{{ task.dueDate | date: 'dd/MM' }}</span>
              </div>
            </div>
          </div>
          <div class="empty-column" *ngIf="todoTasks.length === 0">
            <ng-icon name="heroInboxArrowDown" size="48"></ng-icon>
            <p>Arraste tarefas aqui</p>
          </div>
        </div>
      </div>

      <div 
        class="kanban-column doing-column"
        [class.drag-over]="draggedOverColumn === 'DOING'"
        (dragover)="onDragOver($event)"
        (dragenter)="onDragEnter('DOING', $event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop('DOING', $event)">
        <div class="column-header">
          <h2>
            <ng-icon name="heroCog" size="24"></ng-icon>
            Em Progresso
          </h2>
          <span class="task-count">{{ doingTasks.length }}</span>
        </div>
        <div class="column-content">
          <div 
            class="kanban-card" 
            *ngFor="let task of doingTasks" 
            draggable="true"
            (dragstart)="onDragStart(task, $event)"
            (dragend)="onDragEnd($event)"
            (click)="navigateToTask(task.id)">
            <div class="card-header">
              <h3>{{ task.title }}</h3>
              <span class="priority-badge" [ngClass]="getPriorityClass(task.priority)">
                {{ getPriorityLabel(task.priority) }}
              </span>
            </div>
            <p class="card-description">{{ task.description }}</p>
            <div class="card-footer">
              <div class="card-info">
                <ng-icon name="heroUser" size="16"></ng-icon>
                <span>{{ task.assignee.name }}</span>
              </div>
              <div class="card-info">
                <ng-icon name="heroCalendar" size="16"></ng-icon>
                <span>{{ task.dueDate | date: 'dd/MM' }}</span>
              </div>
            </div>
          </div>
          <div class="empty-column" *ngIf="doingTasks.length === 0">
            <ng-icon name="heroInboxArrowDown" size="48"></ng-icon>
            <p>Arraste tarefas aqui</p>
          </div>
        </div>
      </div>

      <div 
        class="kanban-column done-column"
        [class.drag-over]="draggedOverColumn === 'DONE'"
        (dragover)="onDragOver($event)"
        (dragenter)="onDragEnter('DONE', $event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop('DONE', $event)">
        <div class="column-header">
          <h2>
            <ng-icon name="heroCheckCircle" size="24"></ng-icon>
            Conclu√≠da
          </h2>
          <span class="task-count">{{ doneTasks.length }}</span>
        </div>
        <div class="column-content">
          <div 
            class="kanban-card completed" 
            *ngFor="let task of doneTasks" 
            draggable="true"
            (dragstart)="onDragStart(task, $event)"
            (dragend)="onDragEnd($event)"
            (click)="navigateToTask(task.id)">
            <div class="card-header">
              <h3>{{ task.title }}</h3>
              <span class="priority-badge" [ngClass]="getPriorityClass(task.priority)">
                {{ getPriorityLabel(task.priority) }}
              </span>
            </div>
            <p class="card-description">{{ task.description }}</p>
            <div class="card-footer">
              <div class="card-info">
                <ng-icon name="heroUser" size="16"></ng-icon>
                <span>{{ task.assignee.name }}</span>
              </div>
              <div class="card-info">
                <ng-icon name="heroCalendar" size="16"></ng-icon>
                <span>{{ task.dueDate | date: 'dd/MM' }}</span>
              </div>
            </div>
          </div>
          <div class="empty-column" *ngIf="doneTasks.length === 0">
            <ng-icon name="heroInboxArrowDown" size="48"></ng-icon>
            <p>Arraste tarefas aqui</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
